# MCP服务管理器业务逻辑文档

## 概述
业务逻辑层负责处理MCP服务管理的核心功能，包括服务的增删改查、连接测试以及与MCP服务器的交互获取工具信息。

## 核心服务类

### McpServerService
这是项目的核心服务类，负责处理所有MCP服务相关的业务逻辑。

#### 依赖注入
```java
@Autowired
private McpServerRepository mcpServerRepository;
```

#### 主要方法

##### 1. getAllMcpServers()
**功能**: 获取所有MCP服务  
**实现**: 调用`mcpServerRepository.findAll()`  
**返回值**: `List<McpServer>` - 所有MCP服务列表

##### 2. getMcpServerById(Long id)
**功能**: 根据ID获取MCP服务  
**实现**: 调用`mcpServerRepository.findById(id)`  
**参数**: `id` - 服务ID  
**返回值**: `Optional<McpServer>` - MCP服务可选对象

##### 3. saveMcpServer(McpServer mcpServer)
**功能**: 保存或更新MCP服务  
**实现**: 调用`mcpServerRepository.save(mcpServer)`  
**参数**: `mcpServer` - MCP服务对象  
**返回值**: `McpServer` - 保存后的MCP服务对象

##### 4. deleteMcpServer(Long id)
**功能**: 删除MCP服务  
**实现**: 调用`mcpServerRepository.deleteById(id)`  
**参数**: `id` - 服务ID

##### 5. existsByName(String name)
**功能**: 检查服务名称是否存在  
**实现**: 调用`mcpServerRepository.existsByName(name)`  
**参数**: `name` - 服务名称  
**返回值**: `boolean` - 是否存在

##### 6. getMcpServerByName(String name)
**功能**: 根据名称获取MCP服务  
**实现**: 调用`mcpServerRepository.findByName(name)`  
**参数**: `name` - 服务名称  
**返回值**: `Optional<McpServer>` - MCP服务可选对象

##### 7. getMcpTools(Long serverId)
**功能**: 获取MCP服务的工具列表  
**实现**: 
1. 从数据库获取MCP服务信息
2. 创建MCP客户端连接
3. 初始化连接并测试连通性
4. 调用`listTools()`获取工具列表
5. 转换为McpTool对象列表

**参数**: `serverId` - 服务ID  
**返回值**: `List<McpTool>` - 工具列表  
**异常**: `Exception` - 连接或获取工具失败时抛出

**详细实现**:
```java
public List<McpTool> getMcpTools(Long serverId) throws Exception {
    // 1. 从数据库获取服务信息
    Optional<McpServer> optionalServer = mcpServerRepository.findById(serverId);
    String baseUrl = optionalServer.get().getUrl();
    
    // 2. 创建SSE传输客户端
    String sseEndpoint = "/sse/";
    HttpClientSseClientTransport httpClientSseClientTransport = 
        HttpClientSseClientTransport.builder(baseUrl)
            .sseEndpoint(sseEndpoint)
            .build();
    
    // 3. 创建MCP同步客户端
    McpSyncClient client = McpClient.sync(httpClientSseClientTransport)
        .requestTimeout(Duration.ofSeconds(20L))
        .capabilities(ClientCapabilities.builder()
            .roots(true)
            .sampling()
            .build())
        .build();
    
    // 4. 初始化连接
    client.initialize();
    client.ping(); // 测试连接
    
    // 5. 获取工具列表
    io.modelcontextprotocol.spec.McpSchema.ListToolsResult listTools = client.listTools();
    
    // 6. 转换为内部McpTool对象
    return listTools.tools()
        .stream()
        .map(tool -> new McpTool(tool.name(), tool.description(), 
                tool.inputSchema(), tool.outputSchema()))
        .toList();
}
```

## MCP协议处理

### 支持的MCP格式
本应用支持多种MCP协议的工具发现格式：

1. **标准格式**: `{ "tools": [...] }`
2. **包装在result对象中**: `{ "result": { "tools": [...] } }`
3. **根数组格式**: `[...]`
4. **包装在data对象中**: `{ "data": { "tools": [...] } }`

### 工具信息结构
每个工具包含以下信息：
- `name`: 工具名称
- `description`: 工具描述
- `inputSchema`: 输入参数模式（JSON Schema格式）
- `outputSchema`: 输出结果模式（JSON对象）

### 连接处理
- **传输方式**: 目前主要支持SSE（Server-Sent Events）
- **超时设置**: 默认20秒请求超时
- **客户端能力**: 支持roots和sampling功能
- **连接测试**: 通过ping命令验证连接有效性

## 控制器层业务逻辑

### McpServerController
控制器层负责处理HTTP请求并调用相应的服务方法。

#### 主要业务流程

##### 1. 创建MCP服务流程
1. 接收客户端POST请求
2. 检查是否为新服务且名称已存在
3. 调用`saveMcpServer()`保存服务
4. 返回创建成功的响应

##### 2. 获取工具列表流程
1. 接收客户端GET请求（带服务ID）
2. 调用`getMcpTools()`方法
3. 处理可能的异常
4. 返回工具列表或错误信息

##### 3. 测试连接流程
1. 接收客户端POST请求（带测试配置）
2. 目前为模拟实现，实际应建立真实连接测试
3. 返回测试结果

## 异常处理策略

### 服务层异常
- 数据库操作异常：由JPA自动处理
- MCP连接异常：捕获并包装为业务异常
- 数据验证异常：在控制器层处理

### 控制器层异常处理
- 404错误：资源未找到时返回
- 409错误：资源冲突时返回
- 500错误：服务器内部错误时返回详细信息

## 性能考虑
- **连接复用**: 目前每次获取工具列表都会创建新连接，可考虑连接池优化
- **缓存机制**: 工具列表可考虑缓存以提高响应速度
- **异步处理**: 长时间的连接测试可考虑异步处理

## 安全考虑
- **CORS配置**: 允许所有来源访问，生产环境应限制
- **请求头处理**: 支持自定义请求头，包括认证信息
- **超时控制**: 防止长时间连接占用资源
