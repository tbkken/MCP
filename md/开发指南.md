# MCP服务管理器开发指南

## 概述
本文档为开发者提供MCP服务管理器的开发指导，包括项目结构说明、开发环境搭建、代码规范和扩展开发指南。

## 项目结构详解

### 目录结构
```
src/
├── main/
│   ├── java/com/example/mcpmanager/
│   │   ├── controller/     # REST API控制器层
│   │   ├── entity/         # 数据实体类
│   │   ├── repository/     # 数据访问层
│   │   ├── service/        # 业务逻辑层
│   │   └── McpManagerApplication.java  # 应用启动类
│   └── resources/
│       ├── static/         # 静态资源文件
│       └── application.properties  # 应用配置文件
└── test/                   # 测试代码目录
    └── java/com/example/mcpmanager/    # 测试类
```

### 分层架构说明

#### 控制器层 (Controller)
- **职责**: 处理HTTP请求，参数验证，返回响应
- **包路径**: `com.example.mcpmanager.controller`
- **主要类**: `McpServerController`
- **注解**: `@RestController`, `@RequestMapping`

#### 服务层 (Service)
- **职责**: 实现业务逻辑，处理数据转换
- **包路径**: `com.example.mcpmanager.service`
- **主要类**: `McpServerService`
- **注解**: `@Service`

#### 数据访问层 (Repository)
- **职责**: 数据库操作，CRUD功能
- **包路径**: `com.example.mcpmanager.repository`
- **主要类**: `McpServerRepository`
- **注解**: `@Repository`

#### 实体层 (Entity)
- **职责**: 数据模型定义，ORM映射
- **包路径**: `com.example.mcpmanager.entity`
- **主要类**: `McpServer`, `McpTool`
- **注解**: `@Entity`, `@Table`

## 开发环境搭建

### 必需软件
1. **Java Development Kit**: JDK 11或更高版本
2. **集成开发环境**: IntelliJ IDEA、Eclipse或VS Code
3. **构建工具**: Apache Maven 3.6+
4. **版本控制**: Git

### 环境配置步骤

#### 1. JDK安装
```bash
# 检查Java版本
java -version

# 设置JAVA_HOME环境变量
export JAVA_HOME=/path/to/jdk
```

#### 2. Maven安装
```bash
# 检查Maven版本
mvn -version

# 设置MAVEN_HOME环境变量
export MAVEN_HOME=/path/to/maven
```

#### 3. IDE配置
- **IntelliJ IDEA**: 
  - 导入Maven项目
  - 配置JDK和Maven路径
  - 启用注解处理

- **VS Code**:
  - 安装Java Extension Pack
  - 安装Maven for Java扩展

### 项目导入
```bash
# 克隆项目
git clone <repository-url>

# 导入IDE
# IntelliJ: File -> Open -> 选择项目pom.xml
# Eclipse: File -> Import -> Maven -> Existing Maven Projects
```

## 代码规范

### Java代码规范

#### 命名规范
- **类名**: 大驼峰命名法，如`McpServerService`
- **方法名**: 小驼峰命名法，如`getAllMcpServers`
- **变量名**: 小驼峰命名法，如`mcpServerRepository`
- **常量名**: 全大写加下划线，如`MAX_TIMEOUT`

#### 注解使用
```java
// 实体类注解
@Entity
@Table(name = "mcp_servers")
public class McpServer {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, unique = true)
    private String name;
}

// 服务类注解
@Service
public class McpServerService {
    @Autowired
    private McpServerRepository mcpServerRepository;
}

// 控制器类注解
@RestController
@RequestMapping("/api/mcp-servers")
@CrossOrigin(origins = "*")
public class McpServerController {
    @Autowired
    private McpServerService mcpServerService;
}
```

#### 异常处理
```java
// 控制器层异常处理
@GetMapping("/{id}")
public ResponseEntity<McpServer> getMcpServerById(@PathVariable Long id) {
    Optional<McpServer> mcpServer = mcpServerService.getMcpServerById(id);
    if (mcpServer.isPresent()) {
        return new ResponseEntity<>(mcpServer.get(), HttpStatus.OK);
    } else {
        return new ResponseEntity<>(HttpStatus.NOT_FOUND);
    }
}
```

### 前端代码规范

#### Vue组件结构
```javascript
const app = createApp({
    setup() {
        // 1. 响应式数据定义
        const data = ref([]);
        
        // 2. 方法定义
        const methods = () => {};
        
        // 3. 生命周期钩子
        onMounted(() => {});
        
        // 4. 返回需要暴露的数据和方法
        return {
            data,
            methods
        };
    }
});
```

#### CSS命名规范
- **组件样式**: 使用语义化类名
- **状态样式**: 使用`is-`前缀，如`is-active`
- **工具类**: 使用`u-`前缀，如`u-flex`

## 核心功能开发

### 添加新API接口

#### 1. 在Controller中添加方法
```java
@GetMapping("/statistics")
public ResponseEntity<Map<String, Object>> getServerStatistics() {
    // 实现统计逻辑
    Map<String, Object> statistics = mcpServerService.getServerStatistics();
    return new ResponseEntity<>(statistics, HttpStatus.OK);
}
```

#### 2. 在Service中实现业务逻辑
```java
public Map<String, Object> getServerStatistics() {
    Map<String, Object> statistics = new HashMap<>();
    List<McpServer> servers = mcpServerRepository.findAll();
    statistics.put("totalServers", servers.size());
    statistics.put("activeServers", countActiveServers(servers));
    return statistics;
}
```

### 扩展MCP协议支持

#### 1. 添加新的传输方式
```java
// 在McpServerService中添加WebSocket支持
public List<McpTool> getMcpToolsViaWebSocket(Long serverId) throws Exception {
    Optional<McpServer> optionalServer = mcpServerRepository.findById(serverId);
    String wsUrl = optionalServer.get().getUrl().replace("http", "ws");
    
    // 创建WebSocket客户端连接
    // 实现WebSocket协议交互
    // 获取工具列表
}
```

#### 2. 支持更多工具格式
```java
// 在工具解析逻辑中添加新格式支持
private List<Tool> parseToolsFromResponse(String response) {
    // 支持 { "tools": [...] } 格式
    // 支持 { "result": { "tools": [...] } } 格式
    // 支持新的自定义格式
}
```

### 数据库扩展

#### 1. 添加新字段到实体类
```java
@Entity
@Table(name = "mcp_servers")
public class McpServer {
    // 现有字段...
    
    @Column
    private String description;  // 新增描述字段
    
    @Column
    private LocalDateTime createdAt;  // 新增创建时间字段
}
```

#### 2. 更新Repository接口
```java
@Repository
public interface McpServerRepository extends JpaRepository<McpServer, Long> {
    // 现有方法...
    
    // 新增查询方法
    List<McpServer> findByCreatedAtAfter(LocalDateTime date);
    List<McpServer> findByDescriptionContaining(String keyword);
}
```

## 测试开发

### 单元测试

#### Service层测试
```java
@SpringBootTest
class McpServerServiceTest {
    
    @Autowired
    private McpServerService mcpServerService;
    
    @MockBean
    private McpServerRepository mcpServerRepository;
    
    @Test
    void testGetAllMcpServers() {
        // 准备测试数据
        List<McpServer> mockServers = Arrays.asList(
            new McpServer("test1", "sse", "http://test1.com", 60, null),
            new McpServer("test2", "http", "http://test2.com", 30, null)
        );
        
        // 配置Mock行为
        when(mcpServerRepository.findAll()).thenReturn(mockServers);
        
        // 执行测试
        List<McpServer> result = mcpServerService.getAllMcpServers();
        
        // 验证结果
        assertEquals(2, result.size());
        verify(mcpServerRepository, times(1)).findAll();
    }
}
```

#### Controller层测试
```java
@WebMvcTest(McpServerController.class)
class McpServerControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private McpServerService mcpServerService;
    
    @Test
    void testGetAllMcpServers() throws Exception {
        // 准备测试数据
        List<McpServer> mockServers = Arrays.asList(/* ... */);
        when(mcpServerService.getAllMcpServers()).thenReturn(mockServers);
        
        // 执行请求并验证响应
        mockMvc.perform(get("/api/mcp-servers"))
               .andExpect(status().isOk())
               .andExpect(jsonPath("$.length()").value(2));
    }
}
```

### 集成测试
```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
class McpManagerIntegrationTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    void testCreateAndGetMcpServer() {
        // 创建MCP服务
        McpServer newServer = new McpServer("integration-test", "sse", "http://test.com", 60, null);
        ResponseEntity<McpServer> createResponse = restTemplate.postForEntity(
            "/api/mcp-servers", newServer, McpServer.class);
        
        assertEquals(HttpStatus.CREATED, createResponse.getStatusCode());
        
        // 获取创建的服务
        Long serverId = createResponse.getBody().getId();
        ResponseEntity<McpServer> getResponse = restTemplate.getForEntity(
            "/api/mcp-servers/" + serverId, McpServer.class);
        
        assertEquals(HttpStatus.OK, getResponse.getStatusCode());
        assertEquals("integration-test", getResponse.getBody().getName());
    }
}
```

## 扩展开发指南

### 添加认证授权功能

#### 1. 添加安全依赖
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

#### 2. 配置安全策略
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests(authz -> authz
            .requestMatchers("/api/public/**").permitAll()
            .anyRequest().authenticated()
        ).httpBasic();
        return http.build();
    }
}
```

### 添加日志记录功能

#### 1. 配置日志框架
```properties
# application.properties
logging.level.com.example.mcpmanager=DEBUG
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} - %msg%n
```

#### 2. 在代码中添加日志
```java
@Service
public class McpServerService {
    
    private static final Logger logger = LoggerFactory.getLogger(McpServerService.class);
    
    public List<McpTool> getMcpTools(Long serverId) throws Exception {
        logger.info("Getting tools for server ID: {}", serverId);
        
        try {
            // 业务逻辑...
            logger.debug("Successfully retrieved {} tools", tools.size());
            return tools;
        } catch (Exception e) {
            logger.error("Failed to get tools for server ID: {}", serverId, e);
            throw e;
        }
    }
}
```

### 性能优化

#### 1. 添加缓存支持
```java
@Service
@EnableCaching
public class McpServerService {
    
    @Cacheable(value = "tools", key = "#serverId")
    public List<McpTool> getMcpTools(Long serverId) throws Exception {
        // 原有实现...
    }
    
    @CacheEvict(value = "tools", key = "#serverId")
    public McpServer saveMcpServer(McpServer mcpServer) {
        // 原有实现...
    }
}
```

#### 2. 异步处理
```java
@Service
public class McpServerService {
    
    @Async
    public CompletableFuture<List<McpTool>> getMcpToolsAsync(Long serverId) {
        try {
            List<McpTool> tools = getMcpTools(serverId);
            return CompletableFuture.completedFuture(tools);
        } catch (Exception e) {
            return CompletableFuture.failedFuture(e);
        }
    }
}
```

## 调试技巧

### 后端调试

#### 1. 启用调试模式
```bash
# 启用调试日志
java -Dlogging.level.com.example.mcpmanager=DEBUG -jar app.jar

# 启用SQL日志
java -Dspring.jpa.show-sql=true -jar app.jar
```

#### 2. 使用调试工具
- **IDE调试**: 设置断点，单步执行
- **日志分析**: 查看控制台输出和日志文件
- **数据库查看**: 使用SQLite浏览器查看`mcp.db`文件

### 前端调试

#### 1. 浏览器开发者工具
- **Network面板**: 查看API请求和响应
- **Console面板**: 查看JavaScript错误和日志
- **Elements面板**: 检查DOM结构和样式

#### 2. 调试输出
```javascript
// 添加调试日志
console.log('Debug info:', data);

// 条件调试
if (process.env.NODE_ENV === 'development') {
    console.debug('Development debug info');
}
```

## 版本控制和协作

### Git工作流
```bash
# 创建功能分支
git checkout -b feature/new-feature

# 提交更改
git add .
git commit -m "Add new feature: description"

# 推送到远程仓库
git push origin feature/new-feature

# 合并到主分支
git checkout main
git merge feature/new-feature
git push origin main
```

### 提交信息规范
- **格式**: `<type>(<scope>): <subject>`
- **类型**: feat, fix, docs, style, refactor, test, chore
- **示例**: `feat(server): add WebSocket support`

## 常见问题解答

### 1. 如何添加新的MCP服务类型？
1. 在`McpServer`实体中添加新的类型枚举
2. 在前端下拉选择框中添加新选项
3. 在服务层添加对应的连接逻辑

### 2. 如何扩展工具信息显示？
1. 在`McpTool`实体中添加新字段
2. 修改前端工具详情对话框
3. 更新API响应格式

### 3. 如何优化数据库性能？
1. 添加适当的数据库索引
2. 优化查询语句
3. 考虑分页查询大量数据

### 4. 如何添加国际化支持？
1. 添加多语言资源文件
2. 配置Spring Boot国际化支持
3. 在前端实现语言切换功能
