# MCP服务管理器部署运维文档

## 概述
本文档详细说明MCP服务管理器的部署方式、运行环境要求、运维操作和故障排除方法。

## 系统要求

### 运行环境
- **Java版本**: Java 11或更高版本
- **操作系统**: Windows、Linux、macOS
- **内存**: 最少512MB可用内存
- **磁盘空间**: 最少100MB可用磁盘空间

### 开发环境
- **Maven**: 3.6或更高版本
- **IDE**: IntelliJ IDEA、Eclipse或VS Code
- **数据库工具**: SQLite浏览器（可选，用于调试）

## 部署方式

### 方式一：直接运行脚本（推荐）

#### Linux/Mac系统
```bash
# 赋予执行权限
chmod +x run.sh

# 运行应用
./run.sh
```

#### Windows系统
```cmd
# 运行批处理文件
run.bat
```

### 方式二：Maven运行
```bash
# 清理并编译项目
mvn clean compile

# 运行应用
mvn spring-boot:run
```

### 方式三：打包运行
```bash
# 打包应用
mvn package

# 运行打包后的JAR文件
java -jar target/mcp-manager-0.0.1-SNAPSHOT.jar
```

## 配置文件

### application.properties
位于`src/main/resources/application.properties`：

```properties
# 数据库配置
spring.datasource.url=jdbc:sqlite:mcp.db
spring.datasource.driver-class-name=org.sqlite.JDBC
spring.datasource.username=
spring.datasource.password=

# JPA配置
spring.jpa.database-platform=org.sqlite.hibernate.dialect.SQLiteDialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
```

### 配置说明
- **数据库URL**: `jdbc:sqlite:mcp.db` - SQLite数据库文件路径
- **驱动类**: SQLite JDBC驱动
- **DDL自动更新**: `update` - 自动创建和更新表结构
- **SQL显示**: `true` - 在控制台显示SQL语句（开发环境）

## 数据库管理

### 数据库文件
- **文件名**: `mcp.db`
- **位置**: 项目根目录
- **类型**: SQLite嵌入式数据库

### 数据库结构
自动创建以下表：
1. `mcp_servers`: 存储MCP服务配置
2. `mcp_server_headers`: 存储服务请求头信息

### 备份策略
```bash
# 简单备份
cp mcp.db mcp.db.backup.$(date +%Y%m%d)

# 恢复备份
cp mcp.db.backup.20250814 mcp.db
```

### 数据迁移
- 数据库结构由Hibernate自动管理
- 新版本升级时会自动更新表结构
- 建议升级前备份数据库文件

## 网络配置

### 默认端口
- **HTTP端口**: 8080
- **绑定地址**: localhost（127.0.0.1）

### 自定义端口
通过JVM参数指定端口：
```bash
java -Dserver.port=9090 -jar target/mcp-manager-0.0.1-SNAPSHOT.jar
```

### 外部访问
默认支持跨域访问，可通过以下方式限制：
```bash
# 通过环境变量设置允许的来源
java -Dcors.allowed.origins=https://yourdomain.com -jar app.jar
```

## 日志管理

### 日志输出
- **控制台日志**: 启动信息和错误信息
- **SQL日志**: 启用`show-sql=true`时显示SQL语句
- **文件日志**: 可通过配置文件启用

### 日志配置
在`application.properties`中添加：
```properties
# 日志级别
logging.level.com.example.mcpmanager=DEBUG
logging.level.org.springframework=INFO

# 日志文件
logging.file.name=logs/mcp-manager.log
logging.file.max-size=10MB
```

## 监控和维护

### 健康检查
```bash
# 检查应用是否运行
curl -f http://localhost:8080/actuator/health || echo "Application is down"
```

### 性能监控
目前未集成Spring Boot Actuator，可考虑添加：
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

### 资源监控
- **内存使用**: 监控Java堆内存使用情况
- **线程数**: 监控活跃线程数
- **数据库连接**: SQLite为嵌入式，无连接池

## 故障排除

### 常见问题

#### 1. 端口被占用
**现象**: 启动时提示端口8080被占用
**解决方案**: 
```bash
# 查找占用端口的进程
lsof -i :8080  # Linux/Mac
netstat -ano | findstr :8080  # Windows

# 杀死进程或使用其他端口
java -Dserver.port=9090 -jar app.jar
```

#### 2. 数据库连接失败
**现象**: 启动时报数据库连接错误
**解决方案**:
- 检查`mcp.db`文件权限
- 确认SQLite JDBC驱动是否正确引入
- 检查磁盘空间是否充足

#### 3. MCP服务连接超时
**现象**: 获取工具列表时超时
**解决方案**:
- 检查MCP服务URL是否正确
- 验证网络连通性
- 增加超时时间配置

#### 4. JSON解析错误
**现象**: 添加服务时提示JSON格式错误
**解决方案**:
- 验证JSON格式是否正确
- 检查是否有中文字符编码问题
- 确认字段名称是否正确

### 日志分析
重点关注以下日志信息：
- 启动成功的标志：`Started McpManagerApplication`
- 数据库连接信息：`HHH000400: Using dialect: org.sqlite.hibernate.dialect.SQLiteDialect`
- API访问日志：`GET /api/mcp-servers`
- 错误堆栈信息：`ERROR`级别的日志

## 安全考虑

### 数据安全
- **数据库文件**: 确保`mcp.db`文件的访问权限
- **敏感信息**: 请求头可能包含认证信息，注意文件权限
- **备份安全**: 备份文件应妥善保管

### 网络安全
- **CORS配置**: 生产环境应限制允许的来源
- **API访问**: 目前无认证机制，生产环境应添加认证
- **输入验证**: 前端和后端都应进行输入验证

### 升级安全
- **版本兼容性**: 检查新版本与现有数据的兼容性
- **备份策略**: 升级前务必备份数据库
- **回滚计划**: 准备回滚方案

## 性能优化

### 启动优化
```bash
# JVM参数优化
java -Xms256m -Xmx512m -jar app.jar
```

### 连接优化
- **MCP连接池**: 考虑实现连接池复用
- **工具列表缓存**: 缓存频繁访问的工具信息
- **异步处理**: 长时间操作使用异步处理

### 数据库优化
- **索引优化**: 为常用查询字段添加索引
- **查询优化**: 优化复杂查询语句
- **定期维护**: 定期清理无用数据

## 备份和恢复

### 定期备份
```bash
#!/bin/bash
# 备份脚本示例
BACKUP_DIR="./backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
cp mcp.db $BACKUP_DIR/mcp.db.$DATE
echo "Backup created: $BACKUP_DIR/mcp.db.$DATE"
```

### 灾难恢复
1. 停止应用服务
2. 恢复数据库文件
3. 重新启动应用
4. 验证数据完整性

## 监控脚本示例

### 健康检查脚本
```bash
#!/bin/bash
# health-check.sh
APP_URL="http://localhost:8080"
TIMEOUT=5

if curl -f --max-time $TIMEOUT $APP_URL/api/mcp-servers > /dev/null 2>&1; then
    echo "Application is running"
    exit 0
else
    echo "Application is down"
    exit 1
fi
```

### 重启脚本
```bash
#!/bin/bash
# restart.sh
pkill -f mcp-manager
./run.sh
```

## 版本升级

### 升级步骤
1. 备份当前数据库文件
2. 停止当前应用
3. 部署新版本文件
4. 启动新版本应用
5. 验证功能正常

### 兼容性检查
- 检查数据库表结构变更
- 验证API接口兼容性
- 测试MCP协议兼容性
